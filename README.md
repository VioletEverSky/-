# 图像去噪系统开发说明文档

## 1. 项目概述

### 1.1 项目简介
本项目是一个基于PyQt5开发的图像去噪系统，提供了多种经典的图像去噪算法，支持批量噪声添加和实时预览功能。系统采用图形化界面，操作简便，适用于图像处理教学和实验研究。

### 1.2 主要特性
- **多种噪声类型**：支持高斯噪声、椒盐噪声、泊松噪声、斑点噪声
- **多种去噪算法**：包含传统滤波方法和现代高级算法
- **批量噪声处理**：支持噪声队列，可连续添加多种噪声
- **实时预览**：支持图像缩放、拖拽查看
- **性能评价**：自动计算PSNR和SSIM指标
- **多线程处理**：耗时算法采用多线程，避免界面卡顿

### 1.3 技术栈
- **GUI框架**：PyQt5
- **图像处理**：OpenCV (cv2)
- **数值计算**：NumPy, SciPy
- **小波变换**：PyWavelets
- **图像质量评价**：scikit-image

## 2. 系统架构

### 2.1 整体架构
```
图像去噪系统
├── GUI界面层 (PyQt5)
│   ├── 主界面 (ImageDenoiseApp)
│   ├── 图像显示组件 (ZoomableImage)
│   └── 进度显示组件 (DenoiseWorker)
├── 算法处理层
│   ├── 噪声生成模块
│   ├── 传统滤波模块
│   ├── 小波去噪模块
│   └── BM3D去噪模块
└── 工具函数层
    ├── 图像格式转换
    ├── 质量评价计算
    └── 文件操作
```

### 2.2 核心类设计

#### 2.2.1 ImageDenoiseApp (主应用类)
- **职责**：主界面管理、用户交互、流程控制
- **主要方法**：
  - `init_ui()`: 初始化用户界面
  - `open_image()`: 打开图像文件
  - `denoise_image()`: 执行去噪操作
  - `save_image()`: 保存处理结果

#### 2.2.2 DenoiseWorker (工作线程类)
- **职责**：耗时算法的多线程处理
- **主要方法**：
  - `run()`: 线程主执行函数
  - `bm3d_denoise_with_progress()`: 带进度的BM3D去噪
  - `wavelet_denoise_with_progress()`: 带进度的小波去噪

#### 2.2.3 ZoomableImage (图像查看器)
- **职责**：图像缩放、拖拽查看
- **主要方法**：
  - `update_pixmap()`: 更新显示图像
  - `eventFilter()`: 处理鼠标事件

## 3. 功能模块详解

### 3.1 噪声生成模块

#### 3.1.1 支持的噪声类型
```python
def add_noise(img, noise_type, strength):
    """
    添加噪声到图像
    
    参数:
    - img: 输入图像
    - noise_type: 噪声类型 ("高斯噪声", "椒盐噪声", "泊松噪声", "斑点噪声")
    - strength: 噪声强度 (0-1)
    """
```

#### 3.1.2 噪声队列机制
- 支持连续添加多种噪声
- 噪声队列显示和管理
- 批量应用噪声序列

### 3.2 去噪算法模块

#### 3.2.1 传统滤波方法
```python
def denoise(img, method):
    """
    传统滤波去噪方法
    
    支持的方法:
    - 均值滤波: cv2.blur()
    - 高斯滤波: cv2.GaussianBlur()
    - 中值滤波: cv2.medianBlur()
    - 双边滤波: cv2.bilateralFilter()
    - 非局部均值: cv2.fastNlMeansDenoisingColored()
    """
```

#### 3.2.2 小波去噪算法
```python
def wavelet_denoise(img):
    """
    小波去噪算法实现
    
    特点:
    - 支持彩色图像处理
    - 自动尺寸调整（2的幂次）
    - 软阈值处理
    - 多级小波分解
    """
```

#### 3.2.3 BM3D去噪算法
```python
def bm3d_denoise(img):
    """
    BM3D (Block-Matching and 3D filtering) 去噪算法
    
    特点:
    - 块匹配和3D滤波
    - 支持彩色图像
    - 自适应阈值处理
    - 加权聚合
    """
```

#### 3.2.4 高级BM3D算法
```python
def bm3d_advanced_denoise(img):
    """
    高级BM3D算法 - 两阶段处理
    
    阶段1: 硬阈值处理 - 获得基本估计
    阶段2: 软阈值处理 - 使用基本估计进行精细去噪
    """
```

### 3.3 图像质量评价模块

#### 3.3.1 PSNR计算
```python
def calc_psnr(img1, img2):
    """
    计算峰值信噪比 (Peak Signal-to-Noise Ratio)
    
    返回值: PSNR值 (dB)，越高表示质量越好
    """
```

#### 3.3.2 SSIM计算
```python
def calc_ssim(img1, img2):
    """
    计算结构相似性指数 (Structural Similarity Index)
    
    返回值: SSIM值 (0-1)，越接近1表示越相似
    """
```

## 4. 算法实现细节

### 4.1 小波去噪算法详解

#### 4.1.1 算法流程
1. **图像预处理**：调整图像尺寸为2的幂次
2. **小波分解**：使用db1小波进行2级分解
3. **阈值处理**：对高频系数进行软阈值处理
4. **小波重构**：逆小波变换恢复图像
5. **后处理**：裁剪回原始尺寸并限制像素值范围

#### 4.1.2 关键参数
- **小波基函数**：db1 (Daubechies 1)
- **分解级数**：2级
- **阈值设置**：20 (软阈值)
- **尺寸调整**：向上取整到2的幂次

### 4.2 BM3D算法详解

#### 4.2.1 算法原理
BM3D算法基于以下步骤：
1. **块匹配**：在搜索窗口内寻找相似块
2. **3D分组**：将相似块组成3D数组
3. **3D变换**：对3D数组进行DCT变换
4. **阈值处理**：对变换系数进行软阈值处理
5. **逆变换**：3D逆DCT变换
6. **加权聚合**：将处理后的块加权放回原位置

#### 4.2.2 关键参数
- **块大小**：8×8像素
- **搜索窗口**：16×16像素
- **最大匹配块数**：8个
- **噪声标准差**：20
- **阈值系数**：2.7

#### 4.2.3 相似性判断
```python
# 综合相似性判断
similarity_score = (mean_diff < 1.5 * sigma and 
                  std_diff < 1.5 * sigma and 
                  var_diff < 2.0 * sigma and
                  block_distance < 3.0 * sigma)
```

### 4.3 高级BM3D算法

#### 4.3.1 两阶段处理
1. **第一阶段（硬阈值）**：
   - 使用硬阈值处理获得基本估计
   - 为第二阶段提供参考

2. **第二阶段（软阈值）**：
   - 在基本估计中寻找相似块
   - 对原始图像进行软阈值处理
   - 获得最终去噪结果

## 5. 用户界面设计

### 5.1 界面布局
```
┌─────────────────────────────────────────────────────────────┐
│                    图像去噪系统                              │
├─────────────┬───────────────────────────────────────────────┤
│   操作区    │                图像显示区                     │
│             │  ┌─────────────┬─────────────┐               │
│ 选择图像    │  │   原图像    │  噪声图像   │               │
│ 噪声设置    │  │             │             │               │
│ 去噪算法    │  ├─────────────┼─────────────┤               │
│ 进度显示    │  │  去噪图像   │  评价指标   │               │
│             │  └─────────────┴─────────────┘               │
└─────────────┴───────────────────────────────────────────────┘
```

### 5.2 交互功能
- **图像选择**：支持PNG、JPG、BMP格式
- **噪声控制**：滑块调节噪声强度
- **算法选择**：下拉菜单选择去噪方法
- **进度显示**：实时显示处理进度
- **结果保存**：自动生成带时间戳的文件名

## 6. 性能优化

### 6.1 多线程处理
- 耗时算法使用QThread避免界面卡顿
- 进度信号实时更新UI
- 支持取消操作

### 6.2 内存优化
- 图像处理使用float32精度
- 及时释放临时变量
- 避免不必要的图像复制

### 6.3 算法优化
- BM3D算法使用步长优化减少计算量
- 小波变换使用合适的分解级数
- 相似性判断使用多特征融合

## 7. 文件结构

```
CV_class/
├── ImageDenoise_3.py          # 主程序文件
├── requirements.txt           # 依赖包列表
├── README.md                  # 项目说明
├── 开发说明文档.md            # 本文档
├── 软件使用说明文档.md        # 用户使用说明
├── 性能优化说明.md            # 性能优化说明
├── BM3D_修复说明.md           # BM3D算法修复说明
├── 代码架构图.md              # 代码架构图
└── 参考文献/                  # 相关文献资料
```

## 8. 依赖包说明

### 8.1 核心依赖
```txt
opencv-python>=4.5.0          # 图像处理
numpy>=1.20.0                 # 数值计算
PyQt5>=5.15.0                 # GUI框架
scikit-image>=0.18.0          # 图像质量评价
PyWavelets>=1.1.0             # 小波变换
scipy>=1.7.0                  # 科学计算
```

### 8.2 可选依赖
```txt
matplotlib>=3.3.0             # 图像显示（可选）
pillow>=8.0.0                 # 图像格式支持（可选）
```

## 9. 安装和运行

### 9.1 环境要求
- Python 3.7+
- Windows/Linux/macOS
- 至少4GB内存（推荐8GB）

### 9.2 安装步骤
```bash
# 1. 克隆或下载项目
git clone <repository_url>
cd CV_class

# 2. 安装依赖
pip install -r requirements.txt

# 3. 运行程序
python ImageDenoise_3.py
```

### 9.3 打包为可执行文件
```bash
# 使用PyInstaller打包
pip install pyinstaller
pyinstaller --onefile --windowed ImageDenoise_3.py
```

## 10. 测试和验证

### 10.1 功能测试
- [x] 图像加载和显示
- [x] 噪声添加功能
- [x] 各种去噪算法
- [x] 质量评价计算
- [x] 结果保存功能
- [x] 多线程处理

### 10.2 性能测试
- [x] 小图像处理（<1MB）
- [x] 中等图像处理（1-10MB）
- [x] 大图像处理（>10MB）
- [x] 内存使用监控
- [x] 处理时间统计

### 10.3 兼容性测试
- [x] Windows 10/11
- [x] Python 3.7-3.11
- [x] 不同分辨率显示器
- [x] 不同图像格式

## 11. 常见问题解决

### 11.1 安装问题
**问题**：PyQt5安装失败
**解决**：使用conda安装或下载预编译包

**问题**：OpenCV导入错误
**解决**：确保安装opencv-python而不是opencv

### 11.2 运行问题
**问题**：程序启动缓慢
**解决**：检查Python环境和依赖包版本

**问题**：内存不足
**解决**：处理大图像时关闭其他程序

### 11.3 算法问题
**问题**：BM3D算法运行缓慢
**解决**：调整参数或使用快速版本

**问题**：小波去噪效果不佳
**解决**：调整阈值参数或分解级数

## 12. 扩展开发

### 12.1 添加新算法
1. 在`denoise()`函数中添加新方法
2. 实现具体的算法函数
3. 在UI中添加选项
4. 更新文档说明

### 12.2 优化现有算法
1. 分析性能瓶颈
2. 优化关键参数
3. 改进算法实现
4. 测试效果对比

### 12.3 添加新功能
1. 批量处理功能
2. 参数自动调优
3. 结果对比分析
4. 报告生成功能

## 13. 版本历史

### v3.0 (当前版本)
- 添加高级BM3D算法
- 优化多线程处理
- 改进用户界面
- 完善错误处理

### v2.0
- 添加BM3D算法
- 实现小波去噪
- 添加进度显示
- 优化图像显示

### v1.0
- 基础滤波算法
- 简单GUI界面
- 基本噪声添加

## 14. 贡献指南

### 14.1 代码规范
- 使用Python PEP 8规范
- 添加详细的函数文档
- 使用有意义的变量名
- 添加适当的注释

### 14.2 提交规范
- 清晰的提交信息
- 完整的测试用例
- 更新的文档说明
- 性能影响评估

## 15. 联系方式

- 邮箱：[072160226@nuaa.edu.cn]

---

**文档版本**：v1.0   
